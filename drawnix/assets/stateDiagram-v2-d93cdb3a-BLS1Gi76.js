import{s as J,d as B,p as Q,D as X,a as H,b as Z,S as F,c as I}from"./styles-6aaf32cf-DX0Q6uAr.js";import{G as tt}from"./graph-CZ97irWc.js";import{l as E,g,d as x,B as et,e as ot,k as w}from"./index-BkkyqH7o.js";import{r as st}from"./index-3862675e-XR8IX4M9.js";import"./layout-BnX3MQGp.js";import"./index-BZdAMdcy.js";import"./clone-DoEUxr2i.js";import"./edges-e0da2a9e-C2nM4eph.js";import"./createText-2e5e7dd3-DevVXwc5.js";import"./index.dom-C3-224fz.js";import"./line-Du8iVD87.js";import"./array-BKyUJesY.js";import"./path-CbwjOpE9.js";const h="rect",C="rectWithTitle",nt="start",it="end",ct="divider",rt="roundedWithTitle",lt="note",at="noteGroup",_="statediagram",dt="state",Et=`${_}-${dt}`,U="transition",St="note",Tt="note-edge",pt=`${U} ${Tt}`,_t=`${_}-${St}`,ut="cluster",Dt=`${_}-${ut}`,bt="cluster-alt",ft=`${_}-${bt}`,V="parent",m="note",At="state",N="----",ht=`${N}${m}`,M=`${N}${V}`,Y="fill:none",W="fill: #333",z="c",q="text",K="normal";let y={},d=0;const yt=function(t){const e=Object.keys(t);for(const s of e)t[s]},gt=function(t,e){return e.db.extract(e.db.getRootDocV2()),e.db.getClasses()};function $t(t){return null==t?"":t.classes?t.classes.join(" "):""}function R(t="",e=0,s="",o=N){const i=null!==s&&s.length>0?`${o}${s}`:"";return`${At}-${t}${i}-${e}`}const A=(t,e,s,o,i,a)=>{const r=s.id,n=$t(o[r]);if("root"!==r){let e=h;!0===s.start&&(e=nt),!1===s.start&&(e=it),s.type!==H&&(e=s.type),y[r]||(y[r]={id:r,shape:e,description:w.sanitizeText(r,g()),classes:`${n} ${Et}`});const o=y[r];s.description&&(Array.isArray(o.description)?(o.shape=C,o.description.push(s.description)):o.description.length>0?(o.shape=C,o.description===r?o.description=[s.description]:o.description=[o.description,s.description]):(o.shape=h,o.description=s.description),o.description=w.sanitizeTextOrArray(o.description,g())),1===o.description.length&&o.shape===C&&(o.shape=h),!o.type&&s.doc&&(E.info("Setting cluster for ",r,G(s)),o.type="group",o.dir=G(s),o.shape=s.type===Z?ct:rt,o.classes=o.classes+" "+Dt+" "+(a?ft:""));const i={labelStyle:"",shape:o.shape,labelText:o.description,classes:o.classes,style:"",id:r,dir:o.dir,domId:R(r,d),type:o.type,padding:15,centerLabel:!0};if(s.note){const e={labelStyle:"",shape:lt,labelText:s.note.text,classes:_t,style:"",id:r+ht+"-"+d,domId:R(r,d,m),type:o.type,padding:15},a={labelStyle:"",shape:at,labelText:s.note.text,classes:o.classes,style:"",id:r+M,domId:R(r,d,V),type:"group",padding:0};d++;const n=r+M;t.setNode(n,a),t.setNode(e.id,e),t.setNode(r,i),t.setParent(r,n),t.setParent(e.id,n);let c=r,l=e.id;"left of"===s.note.position&&(c=e.id,l=r),t.setEdge(c,l,{arrowhead:"none",arrowType:"",style:Y,labelStyle:"",classes:pt,arrowheadStyle:W,labelpos:z,labelType:q,thickness:K})}else t.setNode(r,i)}e&&"root"!==e.id&&(E.trace("Setting node ",r," to be child of its parent ",e.id),t.setParent(r,e.id)),s.doc&&(E.trace("Adding nodes children "),xt(t,s,s.doc,o,i,!a))},xt=(t,e,s,o,i,a)=>{E.trace("items",s),s.forEach(s=>{switch(s.stmt){case I:case H:A(t,e,s,o,i,a);break;case F:{A(t,e,s.state1,o,i,a),A(t,e,s.state2,o,i,a);const r={id:"edge"+d,arrowhead:"normal",arrowTypeEnd:"arrow_barb",style:Y,labelStyle:"",label:w.sanitizeText(s.description,g()),arrowheadStyle:W,labelpos:z,labelType:q,thickness:K,classes:U};t.setEdge(s.state1.id,s.state2.id,r,d),d++}}})},G=(t,e=X)=>{let s=e;if(t.doc)for(let e=0;e<t.doc.length;e++){const o=t.doc[e];"dir"===o.stmt&&(s=o.value)}return s},Ct=async function(t,e,s,o){E.info("Drawing state diagram (v2)",e),y={},o.db.getDirection();const{securityLevel:i,state:a}=g(),r=a.nodeSpacing||50,n=a.rankSpacing||50;E.info(o.db.getRootDocV2()),o.db.extract(o.db.getRootDocV2()),E.info(o.db.getRootDocV2());const d=o.db.getStates(),c=new tt({multigraph:!0,compound:!0}).setGraph({rankdir:G(o.db.getRootDocV2()),nodesep:r,ranksep:n,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}});let l;A(c,void 0,o.db.getRootDocV2(),d,o.db,!0),"sandbox"===i&&(l=x("#i"+e));const p=x("sandbox"===i?l.nodes()[0].contentDocument.body:"body"),b=p.select(`[id="${e}"]`),m=p.select("#"+e+" g");await st(m,c,["barb"],_,e);et.insertTitle(b,"statediagramTitleText",a.titleTopMargin,o.db.getDiagramTitle());const u=b.node().getBBox(),f=u.width+16,$=u.height+16;b.attr("class",_);const w=b.node().getBBox();ot(b,$,f,a.useMaxWidth);const T=`${w.x-8} ${w.y-8} ${f} ${$}`;E.debug(`viewBox ${T}`),b.attr("viewBox",T);const D=document.querySelectorAll('[id="'+e+'"] .edgeLabel .label');for(const t of D){const e=t.getBBox(),s=document.createElementNS("http://www.w3.org/2000/svg",h);s.setAttribute("rx",0),s.setAttribute("ry",0),s.setAttribute("width",e.width),s.setAttribute("height",e.height),t.insertBefore(s,t.firstChild)}},Rt={setConf:yt,getClasses:gt,draw:Ct},mt={parser:Q,db:B,renderer:Rt,styles:J,init:t=>{t.state||(t.state={}),t.state.arrowMarkerAbsolute=t.arrowMarkerAbsolute,B.clear()}};export{mt as diagram};