const CACHE_NAME="eternlty-blog-v1.0.0",OFFLINE_PAGE="/offline.html",CORE_FILES=["/","/offline.html","/css/index.css","/css/var.css","/js/main.js","/js/utils.js","/manifest.json"],CACHE_PATTERNS=[/\.(?:js|css|html|png|jpg|jpeg|gif|webp|svg|ico|woff|woff2|ttf|eot)$/,/^https:\/\/cdn\./,/^https:\/\/fonts\./],IGNORE_PATTERNS=[/\/api\//,/\/admin/,/\?.*nocache/,/\/wp-admin/,/\/wp-login/];function cacheFirstStrategy(e){return caches.open(CACHE_NAME).then(t=>t.match(e).then(n=>n?(console.log("[SW] Cache hit:",e.url),t.add(e.clone()).catch(e=>{console.warn("[SW] Background update failed:",e)}),n):(console.log("[SW] Cache miss, fetching:",e.url),fetch(e).then(n=>(200===n.status&&t.put(e,n.clone()),n)).catch(e=>{throw console.error("[SW] Fetch failed:",e),e}))))}function networkFirstStrategy(e){return fetch(e).then(t=>{if(200===t.status){const n=t.clone();caches.open(CACHE_NAME).then(t=>{t.put(e,n)})}return t}).catch(t=>(console.log("[SW] Network failed, trying cache:",e.url),caches.match(e).then(e=>e||caches.match(OFFLINE_PAGE))))}self.addEventListener("install",e=>{console.log("[SW] Install event"),e.waitUntil(caches.open(CACHE_NAME).then(e=>(console.log("[SW] Pre-caching core files"),e.addAll(CORE_FILES.map(e=>new Request(e,{cache:"reload"}))))).then(()=>(console.log("[SW] Core files cached successfully"),self.skipWaiting())).catch(e=>{console.error("[SW] Failed to cache core files:",e)}))}),self.addEventListener("activate",e=>{console.log("[SW] Activate event"),e.waitUntil(caches.keys().then(e=>Promise.all(e.filter(e=>e!==CACHE_NAME).map(e=>(console.log("[SW] Deleting old cache:",e),caches.delete(e))))).then(()=>(console.log("[SW] Cache cleanup completed"),self.clients.claim())))}),self.addEventListener("fetch",e=>{const t=e.request,n=new URL(t.url);if("GET"!==t.method)return;if(IGNORE_PATTERNS.some(e=>e.test(n.pathname)))return;CACHE_PATTERNS.some(e=>e.test(t.url))?e.respondWith(cacheFirstStrategy(t)):n.origin===location.origin&&t.headers.get("accept").includes("text/html")&&e.respondWith(networkFirstStrategy(t))}),self.addEventListener("sync",e=>{console.log("[SW] Background sync event:",e.tag),"background-sync"===e.tag&&e.waitUntil(Promise.resolve())}),self.addEventListener("push",e=>{console.log("[SW] Push event received");const t={body:e.data?e.data.text():"您有新的消息",icon:"/img/pwa/icon-192x192.png",badge:"/img/pwa/icon-72x72.png",vibrate:[100,50,100],data:{dateOfArrival:Date.now(),primaryKey:1},actions:[{action:"explore",title:"查看",icon:"/img/pwa/icon-96x96.png"},{action:"close",title:"关闭",icon:"/img/pwa/icon-96x96.png"}]};e.waitUntil(self.registration.showNotification("Eternlty's Blog",t))}),self.addEventListener("notificationclick",e=>{console.log("[SW] Notification click received."),e.notification.close(),"explore"===e.action&&e.waitUntil(clients.openWindow("/"))}),console.log("[SW] Service Worker loaded successfully");